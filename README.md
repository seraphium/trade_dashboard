# IBKR 交易面板

一个基于 Streamlit 的交互式交易分析工具，支持从 IBKR Flex API 获取数据并进行深度分析。

## 功能特性

- 📊 **交易数据分析**: 可视化交易记录、盈亏分析、交易量统计
- ⏱️ **时间加权收益率(TWR)**: 专业的投资绩效评估，剔除现金流影响
- 📈 **基准指数对比**: 与主流指数进行表现对比分析
- 💬 **交易评论管理**: 为交易添加评论和标签
- 🔄 **实时数据更新**: 支持定期刷新数据

## 重要更新说明

### TWR收益率计算逻辑修复 (v2.1)

**问题1**: 之前的TWR收益率显示为累计复合收益率，导致数值异常偏高（每天显示百分之十几、二十），与基准指数（2-3%）无法进行有效对比。

**问题2**: 现金流调整逻辑错误，导致有现金流的日子出现异常波动（如从2%一天内跳到20%）。

**解决方案**: 
- **v2.1.0**: 修改TWR时间序列计算逻辑，使其显示累计收益率而非累计复合收益率
- **v2.1.1**: 完全重写现金流调整逻辑，使用正确的时间加权收益率计算方法
- 使用标准TWR公式：每日收益率 = (调整后NAV - 前日NAV) / 前日NAV
- 累计TWR = ∏(1 + 日收益率) - 1，避免简单的NAV减法调整

**计算方式对比**:
- **修正前**: 简单减法调整 `(NAV - 现金流) / 初始NAV - 1`，导致异常波动
- **修正后**: 标准TWR计算 `∏(1 + r_i) - 1`，其中 `r_i = (调整后NAV_i - NAV_{i-1}) / NAV_{i-1}`

## 安装和配置

### 1. 环境要求

- Python 3.8+
- IBKR 账户和 Flex Query 配置
- Financial Datasets API 密钥（可选，用于基准指数数据）

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 配置设置

复制 `config.example.yaml` 为 `config.yaml` 并填入您的配置：

```yaml
ibkr:
  flex_token: "your_flex_token_here"
  trades_query_id: "your_trades_query_id"
  performance_query_id: "your_performance_query_id"  # 用于TWR分析

financial_datasets:
  api_key: "your_api_key_here"  # 可选
```

或者使用环境变量：

```bash
export IBKR_FLEX_TOKEN="your_flex_token"
export IBKR_TRADES_QUERY_ID="your_trades_query_id"
export IBKR_PERFORMANCE_QUERY_ID="your_performance_query_id"
export FINANCIAL_DATASETS_API_KEY="your_api_key"
```

### 4. 运行应用

```bash
streamlit run app.py
```

## 使用指南

### 数据获取（统一方式）

#### 首次使用
1. **配置API信息**: 在侧边栏配置IBKR Flex Token、Trades Query ID、Performance Query ID
2. **设置时间范围**: 选择分析的时间段
3. **选择基准指数**: 选择用于对比的基准指数（如SPY、QQQ）
4. **选择数据类型**: 勾选需要获取的数据类型
   - 📋 **交易数据**: 获取交易记录和投资组合表现
   - 📈 **TWR数据**: 获取NAV和现金流数据，计算时间加权收益率
   - 📊 **基准数据**: 获取基准指数数据进行对比
5. **一键获取**: 点击"🚀 获取所有数据"按钮，系统会显示进度条和实时状态
6. **自动缓存**: 数据获取成功后自动保存到本地CSV文件

#### 后续使用
- **自动加载**: 启动应用时自动加载本地缓存数据
- **快速开始**: 无需重新配置API，直接开始分析
- **更新数据**: 需要新数据时，重新点击"🚀 获取所有数据"按钮

### 分析功能

- **📊 交易分析**: 查看交易时间线、盈亏分析、交易量统计
- **⏱️ TWR分析**: 专业的时间加权收益率分析，包含绩效指标仪表板
- **🆚 基准对比**: 与SPY、QQQ等基准指数进行表现对比
- **💬 评论管理**: 为交易添加评论和标签
- **🔍 数据验证**: 自动检测NAV异常波动和数据质量问题

### 缓存管理

#### 缓存文件位置
- 所有缓存数据保存在 `cached_data/` 目录下
- 包含以下文件：
  - `trades_data.csv`: 交易数据
  - `nav_data.csv`: NAV数据
  - `cash_flow_data.csv`: 现金流数据
  - `benchmark_data.csv`: 基准指数数据
  - `twr_result.csv`: TWR计算结果

#### 缓存操作
- **查看缓存状态**: 在侧边栏"💾 数据缓存管理"中查看
- **重新加载缓存**: 从本地文件重新加载数据
- **清除缓存**: 删除所有缓存文件和内存数据
- **手动保存**: 将当前内存数据保存到CSV文件

### 故障排查

如果数据获取失败，可以使用侧边栏的"🔧 API连接测试"功能：
- **测试交易数据API**: 验证Trades Query配置
- **测试TWR数据API**: 验证Performance Query配置
- **测试基准数据API**: 验证Financial Datasets API配置

如果缓存数据有问题：
- 尝试"🔄 重新加载缓存"
- 或者"🗑️ 清除缓存"后重新获取数据

#### 缓存数据类型问题修复

**问题**：从缓存加载数据后，交易时间线图表可能显示为空，特别是在评论字段包含空值的情况下。

**解决方案**：
- 增强了数据类型验证，确保CSV加载时的NaN值正确转换为字符串
- 改进了图表生成器对空评论的处理
- 在缓存加载和保存时都进行数据类型验证

**技术细节**：
- `validate_trades_data_types()` 函数现在正确处理CSV中的NaN值
- 图表生成器使用 `pd.notna()` 和安全的字符串处理
- 评论字段的空值统一显示为"无"

#### TWR收益曲线缓存问题修复

**问题**：重新打开应用时，TWR收益曲线显示为空，即使有缓存数据。

**原因**：TWR结果中的 `twr_timeseries` 数据（DataFrame类型）在保存时被跳过，只保存了基本数据类型。

**解决方案**：
- 分离保存TWR基本数据和时间序列数据到不同的CSV文件
- 改进加载逻辑，重新组装完整的TWR结果对象
- 更新图表生成器，支持从 `twr_timeseries` 数据生成图表

**技术实现**：
- 新增 `twr_timeseries.csv` 文件专门保存时间序列数据
- 修改 `create_twr_chart()` 函数，支持从缓存的时间序列数据生成图表
- 增强错误处理，避免 `NoneType` 错误

## 技术架构

### 核心模块

- `app.py`: 主应用界面
- `data_fetcher.py`: IBKR数据获取
- `twr_calculator.py`: TWR计算引擎
- `benchmark_data.py`: 基准指数数据
- `chart_utils.py`: 图表生成
- `comment_manager.py`: 评论管理

### TWR计算原理

时间加权收益率(TWR)通过以下步骤计算：

1. **数据预处理**: 清理NAV和现金流数据
2. **时间分割**: 按现金流事件分割时间区间
3. **区间计算**: 计算每个子区间的收益率
4. **几何连乘**: 将各区间收益率几何连乘得到总TWR
5. **累计显示**: 显示从投资开始到当日的累计收益率

### 数据验证

- 与IBKR官方PortfolioAnalyst对比验证
- 支持多种Flex Query配置
- 完整的错误处理和重试机制

## 故障排除

### 常见问题

1. **API连接失败**
   - 检查Flex Token和Query ID是否正确
   - 确认Flex Query状态为"Active"
   - 验证网络连接

2. **TWR计算异常**
   - 确保Performance Query包含NAV和现金流数据
   - 检查数据时间范围设置
   - 查看日志获取详细错误信息

3. **基准数据获取失败**
   - 检查Financial Datasets API密钥
   - 确认网络连接正常
   - 尝试使用模拟数据

## 更新日志

### v2.1.5 (2024-01)
- 🔧 **修复数据类型错误**: 解决从CSV加载数据时comment列类型不兼容的问题
- 🛡️ **数据类型验证**: 添加自动数据类型验证和修正功能
- 📊 **改进数据处理**: 确保所有数据在加载、保存和显示时类型正确

### v2.1.4 (2024-01)
- 💾 **本地数据缓存**: 自动保存获取的数据到本地CSV文件
- 🚀 **快速启动**: 启动时自动加载缓存数据，无需重新获取
- 📁 **缓存管理**: 可查看、重新加载、清除本地缓存数据
- 🔄 **离线使用**: 有缓存数据时可离线进行数据分析

### v2.1.3 (2024-01)
- 🚀 **统一数据获取**: 将交易数据、TWR数据和基准数据合并为一个按钮获取
- 📊 **进度可视化**: 显示数据获取进度条和实时状态
- ⚙️ **灵活配置**: 可选择获取哪些类型的数据
- 🔧 **独立API测试**: 将API连接测试功能独立出来，便于问题排查

### v2.1.2 (2024-01)
- 🔍 **新增数据验证功能**: 自动检测NAV异常波动和数据质量问题
- 📊 **详细异常分析**: 分析股票和期权价值变化来源
- 🚨 **智能异常提醒**: 自动识别超过10%的单日变化并提供分析
- 📈 **增强调试信息**: 显示完整的NAV分量（股票多头/空头、期权多头/空头）

### v2.1.1 (2024-01)
- 🔧 **修复现金流异常波动问题**: 完全重写TWR时间序列计算逻辑
- ⚡ **改进TWR计算准确性**: 使用标准时间加权收益率公式
- 🐛 **解决一天内收益率暴涨问题**: 正确处理现金流对NAV的影响
- 📊 **增加调试信息**: 在应用中显示详细的TWR计算过程

### v2.1.0 (2024-01)
- 🔧 **修复TWR收益率显示问题**: 修正累计收益率计算逻辑
- 📊 **改进基准对比**: 确保TWR和基准指数使用相同计算方式
- 📝 **更新文档**: 添加详细的技术说明

### v2.0 (2024-01)
- ⏱️ **新增TWR分析功能**: 完整的时间加权收益率计算
- 📈 **基准指数对比**: 支持多指数对比分析
- 🎛️ **绩效指标仪表板**: 可视化关键绩效指标

### v1.0 (2023-12)
- 📊 **基础交易分析**: 交易记录可视化和统计
- 💬 **评论管理**: 交易评论和标签功能
- 🔄 **数据获取**: IBKR Flex API集成

## 贡献

欢迎提交Issue和Pull Request来改进这个项目。

## 许可证

MIT License 